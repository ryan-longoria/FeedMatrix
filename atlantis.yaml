version: 3

workflows:
  nonprod:
    plan:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - init:
            extra_args: ["--backend-config", "backends/nonprod-ue2-animeutopia.backend.tfvars", "--reconfigure"]
        - plan:
            extra_args:
              - "-var-file=tfvars/nonprod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/nonprod-ue2-animeutopia.tfvars"
    apply:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - apply:
            extra_args:
              - "-var-file=tfvars/nonprod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/nonprod-ue2-animeutopia.tfvars"

  nonprod-destroy:
    plan:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - init:
            extra_args: ["--backend-config", "backends/nonprod-ue2-animeutopia.backend.tfvars", "--reconfigure"]
        - plan:
            extra_args:
              - "-destroy"
              - "-var-file=tfvars/nonprod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/nonprod-ue2-animeutopia.tfvars"
    apply:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - apply:
            extra_args:
              - "-destroy"
              - "-var-file=tfvars/nonprod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/nonprod-ue2-animeutopia.tfvars"

  prod:
    plan:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - init:
            extra_args: ["--backend-config", "backends/prod-ue2-animeutopia.backend.tfvars", "--reconfigure"]
        - plan:
            extra_args:
              - "-var-file=tfvars/prod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/prod-ue2-animeutopia.tfvars"
    apply:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - apply:
            extra_args:
              - "-var-file=tfvars/prod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/prod-ue2-animeutopia.tfvars"

  prod-destroy:
    plan:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - init:
            extra_args: ["--backend-config", "backends/prod-ue2-animeutopia.backend.tfvars", "--reconfigure"]
        - plan:
            extra_args:
              - "-destroy"
              - "-var-file=tfvars/prod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/prod-ue2-animeutopia.tfvars"
    apply:
      steps:
        - run: /opt/atlantis/bin/fetch-params.sh
        - apply:
            extra_args:
              - "-destroy"
              - "-var-file=tfvars/prod-ue2-animeutopia.tfvars"
              - "-var-file=/home/atlantis/.atlantis/prod-ue2-animeutopia.tfvars"

projects:
  - name: nonprod
    workflow: nonprod
    dir: .
    workspace: default
    autoplan:
      enabled: true
      when_modified:
        - "./backends/*.tfvars"
        - "./tfvars/*.tfvars"
        - "*.tf"
    repo_locks:
      mode: on_plan

  - name: prod
    workflow: prod
    dir: .
    workspace: default
    autoplan:
      enabled: true
      when_modified:
        - "./backends/*.tfvars"
        - "./tfvars/*.tfvars"
        - "*.tf"
    apply_requirements: [mergeable, undiverged]
    repo_locks:
      mode: on_plan
